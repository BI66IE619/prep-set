<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PrepSet - GPA Calculator</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="logo-wrap">
        <div class="logo"><img src="https://files.catbox.moe/whpn5j.png" alt="logo"></div>
      </div>

      <nav class="nav">
        <a href="main.html"><span class="icon">üè†</span><span class="label link-text">Home</span></a>
        <a href="college-finder.html"><span class="icon">üéì</span><span class="label link-text">College Finder</span></a>
        <a href="essay.html"><span class="icon">‚úçÔ∏è</span><span class="label link-text">Essay Helper</span></a>
        <a href="interview.html"><span class="icon">üé§</span><span class="label link-text">Interview Prep</span></a>
        <a href="study-plan.html"><span class="icon">üìö</span><span class="label link-text">4-Year Plan</span></a>
        <a href="gpa.html" class="active"><span class="icon">üìä</span><span class="label link-text">GPA Calculator</span></a>
      </nav>

      <div class="sidebar-footer">
        <button class="btn ghost" onclick="toggleSidebar()">‚ò∞</button>
        <div class="small-muted">All data saved locally. No accounts required.</div>
      </div>
    </aside>

    <main class="main">
      <div class="header">
        <h1 class="h-title">GPA Calculator</h1>
        <div class="h-sub">Track your GPA, semesters, and AI-generated estimates.</div>
      </div>

      <div class="grid">

        <!-- Semester Settings -->
        <div class="card">
          <h2>Semester Mode</h2>

          <label class="label">Choose semester structure:</label>
          <select id="semesterMode">
            <option value="2">2 Semesters</option>
            <option value="3">3 Trimester System</option>
          </select>

          <label class="label">Current Semester:</label>
          <select id="currentSemester"></select>

          <button class="btn" id="saveSemesterSettings">Save</button>
        </div>

        <!-- Manual GPA Calculator -->
        <div class="card">
          <h2>Manual GPA Input</h2>

          <div id="gradeInputs"></div>

          <button class="btn ghost" id="addClass">Add Class</button>

          <div class="row">
            <button class="btn" id="calcGPA">Calculate</button>
            <button class="btn outline" onclick="downloadOutput('gpaOutput','gpa-history')">Download</button>
            <button class="btn ghost" id="clearGPA">Clear</button>
          </div>

          <div id="gpaOutput" class="output" data-save="gpaHistory"></div>
        </div>

        <!-- AI GPA Generator -->
        <div class="card">
          <h2>AI GPA Estimator</h2>

          <label class="label">Describe your grades (ex: 3 A‚Äôs, 2 B‚Äôs, 1 AP A-)</label>
          <textarea id="aiGpaInput" rows="4"></textarea>

          <button class="btn" id="genAI">Generate AI GPA</button>

          <div id="aiGpaOutput" class="output" data-save="aiGpa"></div>
        </div>

        <!-- GPA History -->
        <div class="card">
          <h2>GPA Tracker (Saved Over Time)</h2>

          <button class="btn" id="saveToHistory">Save Current GPA</button>

          <div id="historyList" class="output" data-save="gpaTimeline"></div>
        </div>

      </div>

    </main>
  </div>

  <script src="app.js"></script>

  <script>
    // --------------------------
    // LOAD SEMESTER MODE
    // --------------------------
    const semesterMode = document.getElementById("semesterMode");
    const currentSemester = document.getElementById("currentSemester");

    function loadSemesterSettings() {
      const savedMode = load("semesterMode") || "2";
      const savedCurrent = load("currentSemester") || "1";

      semesterMode.value = savedMode;

      refreshSemesterOptions(savedMode);
      currentSemester.value = savedCurrent;
    }

    function refreshSemesterOptions(mode) {
      currentSemester.innerHTML = "";
      const count = Number(mode);
      for (let i = 1; i <= count; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = "Semester " + i;
        currentSemester.appendChild(opt);
      }
    }

    document.getElementById("saveSemesterSettings").onclick = () => {
      save("semesterMode", semesterMode.value);
      save("currentSemester", currentSemester.value);
      alert("‚úî Semester settings saved!");
    };

    // --------------------------
    // MANUAL GPA CALCULATOR
    // --------------------------
    const gradeInputs = document.getElementById("gradeInputs");

    function addClassRow(grade = "", weight = "") {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <input class="half" placeholder="Grade (A, B+, C-...)" value="${grade}">
        <input class="half" placeholder="Weight (1 for regular, 1.1 honors, 1.2 AP)" value="${weight}">
      `;
      gradeInputs.appendChild(row);
    }

    document.getElementById("addClass").onclick = () => addClassRow();

    // Auto-load saved class rows
    const savedClasses = JSON.parse(load("classRows") || "[]");
    savedClasses.forEach(cls => addClassRow(cls.grade, cls.weight));
    if (savedClasses.length === 0) addClassRow();

    document.getElementById("calcGPA").onclick = () => {
      const rows = [...gradeInputs.querySelectorAll(".row")];
      let total = 0, count = 0;

      rows.forEach(r => {
        const [gEl, wEl] = r.querySelectorAll("input");
        const g = gEl.value.trim().toUpperCase();
        const w = parseFloat(wEl.value) || 1;

        const scale = {
          "A+": 4.0, "A": 4.0, "A-": 3.7,
          "B+": 3.3, "B": 3.0, "B-": 2.7,
          "C+": 2.3, "C": 2.0, "C-": 1.7,
          "D": 1.0, "F": 0
        };

        if (scale[g] !== undefined) {
          total += scale[g] * w;
          count++;
        }
      });

      const unweighted = total / count;
      const weighted = total / count;

      const out = `
        <b>Unweighted GPA:</b> ${unweighted.toFixed(3)}<br>
        <b>Weighted GPA:</b> ${weighted.toFixed(3)}<br>
        <b>Classes Counted:</b> ${count}
      `;
      document.getElementById("gpaOutput").innerHTML = out;

      // Save rows
      const saved = rows.map(r => {
        const [gEl, wEl] = r.querySelectorAll("input");
        return { grade: gEl.value, weight: wEl.value };
      });
      save("classRows", JSON.stringify(saved));

      save("gpaHistory", out);
    };

    document.getElementById("clearGPA").onclick = () => {
      gradeInputs.innerHTML = "";
      addClassRow();
      save("classRows", "[]");
      document.getElementById("gpaOutput").innerHTML = "";
      save("gpaHistory", "");
    };

    // --------------------------
    // AI GPA GENERATOR
    // --------------------------
    document.getElementById("genAI").onclick = () => {
      const desc = document.getElementById("aiGpaInput").value;

      const prompt = `
      You are a GPA calculator AI. Based on this description: "${desc}",
      generate:
      - Estimated unweighted GPA
      - Estimated weighted GPA
      - Grade breakdown
      - AP / Honors effect
      - 1‚Äìsentence summary
      Format clean lines.
      `;

      generateAndRender(prompt, "aiGpaOutput", "aiGpa");
    };

    // -------------------------
    // GPA TRACKER HISTORY
    // -------------------------
    const historyList = document.getElementById("historyList");
    let timeline = JSON.parse(load("gpaTimeline") || "[]");

    function renderHistory() {
      historyList.innerHTML = timeline
        .map((t, i) => `<div>${i+1}. ${t}</div>`)
        .join("");
    }

    renderHistory();

    document.getElementById("saveToHistory").onclick = () => {
      const curr = document.getElementById("gpaOutput").innerHTML;
      if (!curr.trim()) return alert("Calculate a GPA first.");
      timeline.push(curr);
      save("gpaTimeline", JSON.stringify(timeline));
      renderHistory();
    };

    // INIT
    loadSemesterSettings();
  </script>

</body>
</html>
